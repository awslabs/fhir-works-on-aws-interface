openapi: 3.0.0
info:
  description: This is the AWS Fhir Solution API
  version: 1.0.0
  title: FHIR Solution
  contact:
    email: aws-chamonix-dev@amazon.com
  license:
    name: Apache 2.0
    url: 'http://www.apache.org/licenses/LICENSE-2.0.html'
tags:
  - name: authorization
    description: Calls to authorize the request
  - name: bundle
    description: Operations to handle bundle requests
  - name: history
    description: Operations to search non-active FHIR resources
  - name: search
    description: Operations to search active FHIR resources
  - name: persistence
    description: Operations for CRUD like behaviors on FHIR resources
paths:
  /authz:
    post:
      tags:
        - authorization
      summary: Authorizes if user can perform the action
      operationId: isAuthorized
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizationRequest'
      responses:
        '204':
          description: Access granted
        '403':
          description: Forbidden
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /authz/bundle:
    post:
      tags:
        - authorization
      summary: Authorizes if all elements of a Bundle transactions are authorized
      operationId: isBundleAuthorized
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/AuthorizationBundleRequest'
      responses:
        '204':
          description: Access granted
        '403':
          description: Forbidden
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /bundle/batch:
    post:
      tags:
        - bundle
      summary: Process a batch of requests
      operationId: batch
      description: Process a batch of requests that are not dependent on each other
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/BatchRequest'
        description: Inventory item to add
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BundleResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /bundle/transaction:
    post:
      tags:
        - bundle
      summary: authorize Bundle transactions
      operationId: transaction
      description: Used to authorize Bundle transactions
      requestBody:
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/TransactionRequest'
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/BundleResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /history/{resourceType}/{id}:
    get:
      tags:
        - history
      summary: Search the history of a single FHIR resource instance
      operationId: instanceHistory
      description: Search the history of a single FHIR resource instance
      parameters:
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /history/{resourceType}:
    get:
      tags:
        - history
      summary: Search the history of a single FHIR resource type
      operationId: typeHistory
      description: Search the history of a single FHIR resource type
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /history:
    get:
      tags:
        - history
      summary: Searches all historical resources in the FHIR server
      operationId: globalHistory
      description: Searches all historical resources in the FHIR server
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /search/{resourceType}:
    get:
      tags:
        - search
      summary: Search across a single FHIR resource type
      operationId: typeSearch
      description: Search across a single FHIR resource type
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /search:
    get:
      tags:
        - search
      summary: Searches all resources in the FHIR server
      operationId: globalSearch
      description: Searches all resources in the FHIR server
      responses:
        '200':
          description: Success
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /persistence/{resourceType}:
    post:
      tags:
        - persistence
      summary: create a new FHIR resource
      operationId: createResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /persistence/{resourceType}/{id}:
    get:
      tags:
        - persistence
      summary: read a new FHIR resource
      operationId: readResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      responses:
        '200':
          description: Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    put:
      tags:
        - persistence
      summary: update a new FHIR resource
      operationId: updateResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - persistence
      summary: patch a new FHIR resource
      operationId: patchResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
      responses:
        '200':
          description: Patched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - persistence
      summary: delete a FHIR resource
      operationId: deleteResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      responses:
        '204':
          description: Deleted
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /persistence/{resourceType}/{id}/{vid}:
    get:
      tags:
        - persistence
      summary: read a new FHIR resource
      operationId: vReadResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        - in: path
          name: vid
          required: true
          schema:
            type: string
            example: 1
      responses:
        '200':
          description: Found
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /persistence/conditional/{resourceType}:
    post:
      tags:
        - persistence
      summary: conditionally create a new FHIR resource
      operationId: conditionalCreateResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
                query:
                  type: object
      responses:
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
  /persistence/conditional/{resourceType}/{id}:
    put:
      tags:
        - persistence
      summary: conditionally update a new FHIR resource
      operationId: conditionalUpdateResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
                query:
                  type: object
      responses:
        '200':
          description: Updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '201':
          description: Created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    patch:
      tags:
        - persistence
      summary: conditionally patch a FHIR resource
      operationId: conditionalPatchResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      requestBody:
        content:
          application/json:
            schema:
              type: object
              properties:
                resource:
                  type: object
                query:
                  type: object
      responses:
        '200':
          description: Patched
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/GenericResponse'
        '400':
          description: Request invalid
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'
    delete:
      tags:
        - persistence
      summary: conditionally delete a FHIR resource
      operationId: conditionalDeleteResource
      parameters:
        - in: path
          name: resourceType
          required: true
          schema:
            type: string
            example: Patient
        - in: path
          name: id
          required: true
          schema:
            type: string
            format: uuid
            example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
      responses:
        '204':
          description: Deleted
        '404':
          description: Resource not found
        '500':
          description: Internal service error
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ErrorResponse'

components:
  schemas:
    AuthorizationRequest:
      description: Request to authorize the user based on what they are trying to do
      required:
        - accessToken
        - operation
      properties:
        acessToken:
          type: string
          example: eyJhbGciOUz9.eyJzdWxMjMQ.SflMeKKF2QT
        operation:
          type: string
          example: create
        resourceType:
          type: string
          example: Patient
        id:
          type: string
          format: uuid
          example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        vid:
          type: string
          example: 1
    AuthorizationBundleRequest:
      description: Request to authorize the user based on all the things this bundle is trying to do
      required:
        - accessToken
        - requests
      properties:
        acessToken:
          type: string
          example: eyJhbGciOUz9.eyJzdWxMjMQ.SflMeKKF2QT
        requests:
          type: array
          items:
            $ref: '#/components/schemas/BatchReadWriteRequest'
    ErrorResponse:
      description: Response when errors occur
      required:
        - message
      properties:
        message:
          type: string
          example: Could not find entry
    BundleResponse:
      description: Response for Bundle interactions
      required:
        - batchReadWriteResponses
        - requests
      properties:
        batchReadWriteResponses:
          type: array
          items:
            $ref: '#/components/schemas/BatchReadWriteResponse'
    BatchRequest:
      description: Request to process many operations that are independent of each other
      required:
        - startTime
        - requests
      properties:
        startTime:
          type: string
          format: date-time
          example: 2017-07-21T17:32:28Z
        requests:
          type: array
          items:
            $ref: '#/components/schemas/BatchReadWriteRequest'
    TransactionRequest:
      description: Request to process many operations that are dependent of each other
      required:
        - startTime
        - requests
      properties:
        startTime:
          type: string
          format: date-time
          example: 2017-07-21T17:32:28Z
        requests:
          type: array
          items:
            $ref: '#/components/schemas/BatchReadWriteRequest'
    BatchReadWriteRequest:
      description: A single request representing a Bundle entry
      required:
        - operation
        - resourceType
        - id
        - resource
      properties:
        operation:
          type: string
          example: create
        resourceType:
          type: string
          example: Patient
        id:
          type: string
          format: uuid
          example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        resource:
          type: object
        vid:
          type: string
          example: 1
        fullUrl:
          type: string
          format: url
          example: 'https://www.acme-corp.com/Patient/1234'
        references:
          type: array
          items:
            $ref: '#/components/schemas/Reference'
    BatchReadWriteResponse:
      description: A single response correlating to a single a Bundle entry
      required:
        - operation
        - resource
      properties:
        operation:
          type: string
          example: create
        resourceType:
          type: string
          example: Patient
        id:
          type: string
          format: uuid
          example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        resource:
          type: object
        vid:
          type: string
          example: 1
    GenericResponse:
      description: A generic response for a successful operation
      required:
        - resource
      properties:
        resource:
          type: object
    Reference:
      description: A connection between entries in a Bundle
      required:
        - resourceType
        - id
        - vid
        - rootUrl
        - referenceFullUrl
        - referencePath
      properties:
        resourceType:
          type: string
          example: Patient
        id:
          type: string
          format: uuid
          example: fd8bcf46-ea06-4f9f-af5b-b62f68702d6d
        vid:
          type: string
          example: 1
        rootUrl:
          type: string
          format: url
          example: 'https://www.test-FHIR.com/'
        referenceFullUrl:
          type: string
          format: url
          example: 'https://www.test-FHIR.com/Patient/123'
        referencePath:
          type: string
          description: Where to find the reference in the Bundle entry
          example: 'provider.reference'
  